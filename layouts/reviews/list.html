{{ define "main" }}
{{ $reviewsData := site.Data.reviews }}
{{ $reviews := slice }}
{{ with $reviewsData.items }}
  {{ $reviews = sort . "date" "desc" }}
{{ end }}
{{ $totalReviews := len $reviews }}

{{ $rating := "" }}
{{ with $reviewsData.summary.rating }}
  {{ $rating = printf "%v" . }}
{{ end }}
{{ $reviewCount := "" }}
{{ with $reviewsData.summary.review_count }}
  {{ $reviewCount = printf "%v" . }}
{{ end }}
{{ $sourceName := "Яндекс Карты" }}
{{ with $reviewsData.summary.source_name }}
  {{ $sourceName = . }}
{{ end }}
{{ $sourceURL := "" }}
{{ with $reviewsData.summary.source_url }}
  {{ $sourceURL = . }}
{{ end }}

<section class="relative bg-white text-gray-800 overflow-hidden">
  <div class="absolute inset-0 bg-cover bg-center opacity-50" style="background-image: url('/hero-bg.jpeg');"></div>
  <div class="relative container mx-auto px-6 py-16 md:py-20">
    <div class="max-w-3xl">
      <h1 class="text-3xl md:text-5xl font-bold text-[#D84141] leading-tight mb-4">{{ .Title }}</h1>
      <p class="text-sm md:text-base text-gray-700 mb-8 max-w-2xl">{{ .Description }}</p>
      <div class="flex flex-col sm:flex-row gap-4">
        <a href="#reviews-content" class="border-2 border-[#D84141] text-[#D84141] font-bold py-3 px-6 hover:bg-[#D84141] hover:text-white transition-all duration-300 inline-block rounded-lg">
          Смотреть отзывы
        </a>
        {{ if $sourceURL }}
        <a href="{{ $sourceURL }}" target="_blank" rel="noopener noreferrer" class="border-2 border-[#D84141] text-[#D84141] font-bold py-3 px-6 hover:bg-[#D84141] hover:text-white transition-all duration-300 inline-block rounded-lg">
          Открыть на {{ $sourceName }}
        </a>
        {{ end }}
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-8 max-w-2xl">
        <div class="bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm">
          <p class="text-xs uppercase tracking-wide text-gray-500">Рейтинг</p>
          <p class="text-2xl font-bold text-[#D84141]">{{ $rating | default "—" }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm">
          <p class="text-xs uppercase tracking-wide text-gray-500">Оценок</p>
          <p class="text-2xl font-bold text-gray-900">{{ $reviewCount | default "—" }}</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm">
          <p class="text-xs uppercase tracking-wide text-gray-500">Показано</p>
          <p class="text-2xl font-bold text-gray-900">{{ $totalReviews }}</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="reviews-content" class="subpage-shell py-14">
  <div class="container mx-auto px-6">
    <div class="subpage-grid">
      <aside class="subpage-sidebar">
        <div class="subpage-card subpage-toc">
          <h2>Сводка по отзывам</h2>
          <ul class="space-y-2 text-sm text-gray-700">
            <li><strong>Рейтинг:</strong> {{ $rating | default "—" }}</li>
            <li><strong>Оценок:</strong> {{ $reviewCount | default "—" }}</li>
            <li><strong>Отзывов на странице:</strong> {{ $totalReviews }}</li>
          </ul>
        </div>
        {{ if $sourceURL }}
        <div class="subpage-card subpage-quick">
          <h3>Источник отзывов</h3>
          <p>Оригинальные отзывы доступны в открытом профиле компании на {{ $sourceName }}.</p>
          <a href="{{ $sourceURL }}" target="_blank" rel="noopener noreferrer">Открыть источник</a>
        </div>
        {{ end }}
      </aside>

      <div class="subpage-content-wrap">
        {{ with .Content }}
        <article class="subpage-card subpage-intro">
          <div class="prose prose-xl max-w-none prose-p:my-0">{{ . }}</div>
        </article>
        {{ end }}

        <section class="subpage-card subpage-section">
          <div class="px-6 md:px-8 pt-6 md:pt-7 pb-2 border-b border-gray-100">
            <h2 class="text-2xl font-bold text-gray-900">Все отзывы</h2>
            <p class="text-sm text-gray-500 mt-1">Сортировка: сначала новые.</p>
          </div>
          <div class="px-6 md:px-8 pb-7 pt-6">
            {{ if gt $totalReviews 0 }}
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
              {{ range $reviews }}
              <article class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-4">
                  <span class="inline-flex items-center rounded-full bg-[#FCE9E9] text-[#B02E2E] text-xs font-semibold px-3 py-1">Яндекс</span>
                  {{ with .date }}
                  <time class="text-xs text-gray-500">{{ (time .).Format "02.01.2006" }}</time>
                  {{ end }}
                </div>
                <p class="text-gray-700 leading-relaxed mb-5">{{ .text }}</p>
                <div class="border-t border-gray-200 pt-4">
                  <p class="text-gray-900 font-bold">{{ .author }}</p>
                  {{ with .level }}
                  <p class="text-xs text-gray-500 mt-1">{{ . }}</p>
                  {{ end }}
                </div>
              </article>
              {{ end }}
            </div>
            {{ else }}
            <div class="max-w-3xl bg-white border border-gray-200 rounded-lg p-6">
              <p class="text-gray-600">Отзывы пока не добавлены.</p>
            </div>
            {{ end }}
          </div>
        </section>
      </div>
    </div>
  </div>
</section>
{{ end }}
